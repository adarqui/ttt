//
// ttt [tcpdump top talkers] - adarqui (github.com/adarqui && adarq.org)
//
// If I write this again i'll write it in nodejs.
//

*** READ THE README HERE TO SEE THE CORRECT FORMATTING ***

https://raw.github.com/adarqui/ttt/master/README.txt

***/READ THE README HERE TO SEE THE CORRECT FORMATTING ***




This parser will create a sorted (by total byte count) table of traffic from a tcpdump log file:

 # tcpdump -tt -nn -q -i derp0 > dump.txt
 # perl ttt.pl --in dump.txt 

Or (fortigate support):

 FORTIGATE~# diag sniffer packet any none 0 <-- need verbose level of 0
 past that into dump.txt
 # perl ttt.pl --in dump.txt --fort



Quick example usage. The last example is for pasting into the iptrafdjs experimental code: (https://boingterd.com:65503 && https://github.com/adarqui/iptrafdjs). The different output styles are annoying but needed for various reasons.


root@serv:~/admin/git/ttt# perl ttt.pl --in dump.txt
Flows:
Index      Total_Bytes     Protocol   Src             Dst             Port       Time (s)   
1          936638          TCP        11.111.11.111   192.168.1.50    65505      122       
2          89674           UDP        192.168.1.50    11.111.11.111   56741      140       
3          52553           TCP        10.200.1.18     10.200.1.1      22         1         
4          43839           TCP        192.168.1.50    199.193.251.107 80         12        
5          18611           UDP        199.193.251.108 192.168.1.50    1194       139       
6          14372           UDP        10.200.1.10     10.200.1.1      1514       137       
7          3456            ICMP       192.168.1.50    8.8.8.8                    139       
8          3296            TCP        11.111.11.111   192.168.1.50    22         5         
9          1476            UDP        192.168.1.50    64.13.172.36    50231      130       
10         1105            UDP        10.200.1.18     10.200.1.1      1514       21        
11         694             UDP        10.200.1.14     10.200.1.1      1514       1         
12         576             TCP        10.200.1.1      10.200.1.18     46323      140       
13         509             UDP        127.0.0.1       127.0.0.1       51390      0         
14         509             UDP        127.0.0.1       127.0.0.1       52233      0         
15         509             UDP        127.0.0.1       127.0.0.1       43625      0         
16         509             UDP        127.0.0.1       127.0.0.1       40731      0         
17         453             UDP        192.168.1.50    192.168.1.1     53         1         
18         446             UDP        127.0.0.1       127.0.0.1       53         0         
19         318             UDP        69.251.184.163  192.168.1.50    1194       136       
20         185             UDP        127.0.0.1       127.0.0.1       59605      0         
21         181             UDP        127.0.0.1       127.0.0.1       35843      0         
22         128             ICMP       192.168.1.50    4.2.2.2                    1         
23         123             UDP        127.0.0.1       127.0.0.1       57377      0         
24         74              TCP        192.168.1.50    67.218.118.62   6667       1         
25         48              ICMP       192.168.1.50    221.1.118.174              0         
26         0               TCP        220.202.0.188   192.168.56.100  22         1         
27         0               TCP        221.1.118.174   192.168.56.100  1433       1         

root@serv:~/admin/git/ttt# perl ttt.pl --in dump.txt --iponly
Flows:
Index      Total_Bytes     Protocol   Src             Dst             Port       Time (s)
1          939934          TCP        11.111.11.111   192.168.1.50               1
2          89674           UDP        192.168.1.50    11.111.11.111              140
3          53129           TCP        10.200.1.18     10.200.1.1                 31
4          43839           TCP        192.168.1.50    199.193.251.107            12
5          18611           UDP        199.193.251.108 192.168.1.50               139
6          14372           UDP        10.200.1.10     10.200.1.1                 137
7          3456            ICMP       192.168.1.50    8.8.8.8                    139
8          2971            UDP        127.0.0.1       127.0.0.1                  0
9          1476            UDP        192.168.1.50    64.13.172.36               130
10         1105            UDP        10.200.1.18     10.200.1.1                 21
11         694             UDP        10.200.1.14     10.200.1.1                 1
12         453             UDP        192.168.1.50    192.168.1.1                1
13         318             UDP        69.251.184.163  192.168.1.50               136
14         128             ICMP       192.168.1.50    4.2.2.2                    1
15         74              TCP        192.168.1.50    67.218.118.62              1
16         48              ICMP       192.168.1.50    221.1.118.174              0
17         0               TCP        221.1.118.174   192.168.56.100             1
18         0               TCP        220.202.0.188   192.168.56.100             1

root@serv:~/admin/git/ttt# perl ttt.pl --in dump.txt --dots=1
Flows:
Index......Total_Bytes.....Protocol...Src.............Dst.............Port.......Time (s)..
1..........936638..........TCP........11.111.11.111...192.168.1.50....65505......122.......
2..........89674...........UDP........192.168.1.50....11.111.11.111...56741......140.......
3..........52553...........TCP........10.200.1.18.....10.200.1.1......22.........1.........
4..........43839...........TCP........192.168.1.50....199.193.251.107.80.........12........
5..........18611...........UDP........199.193.251.108.192.168.1.50....1194.......139.......
6..........14372...........UDP........10.200.1.10.....10.200.1.1......1514.......137.......
7..........3456............ICMP.......192.168.1.50....8.8.8.8....................139.......
8..........3296............TCP........11.111.11.111...192.168.1.50....22.........5.........
9..........1476............UDP........192.168.1.50....64.13.172.36....50231......130.......
10.........1105............UDP........10.200.1.18.....10.200.1.1......1514.......21........
11.........694.............UDP........10.200.1.14.....10.200.1.1......1514.......1.........
12.........576.............TCP........10.200.1.1......10.200.1.18.....46323......140.......
13.........509.............UDP........127.0.0.1.......127.0.0.1.......51390......0.........
14.........509.............UDP........127.0.0.1.......127.0.0.1.......52233......0.........
15.........509.............UDP........127.0.0.1.......127.0.0.1.......43625......0.........
16.........509.............UDP........127.0.0.1.......127.0.0.1.......40731......0.........
17.........453.............UDP........192.168.1.50....192.168.1.1.....53.........1.........
18.........446.............UDP........127.0.0.1.......127.0.0.1.......53.........0.........
19.........318.............UDP........69.251.184.163..192.168.1.50....1194.......136.......
20.........185.............UDP........127.0.0.1.......127.0.0.1.......59605......0.........
21.........181.............UDP........127.0.0.1.......127.0.0.1.......35843......0.........
22.........128.............ICMP.......192.168.1.50....4.2.2.2....................1.........
23.........123.............UDP........127.0.0.1.......127.0.0.1.......57377......0.........
24.........74..............TCP........192.168.1.50....67.218.118.62...6667.......1.........
25.........48..............ICMP.......192.168.1.50....221.1.118.174..............0.........
26.........0...............TCP........220.202.0.188...192.168.56.100..22.........1.........
27.........0...............TCP........221.1.118.174...192.168.56.100..1433.......1.........

root@serv:~/admin/git/ttt# perl ttt.pl --in dump.txt --columns=0 --csv=1
Flows:
1 , total_bytes=936638 , proto=TCP , src=11.111.11.111 , dst=192.168.1.50 , dport=65505 , time=122
2 , total_bytes=89674 , proto=UDP , src=192.168.1.50 , dst=11.111.11.111 , dport=56741 , time=140
3 , total_bytes=52553 , proto=TCP , src=10.200.1.18 , dst=10.200.1.1 , dport=22 , time=1
4 , total_bytes=43839 , proto=TCP , src=192.168.1.50 , dst=199.193.251.107 , dport=80 , time=12
5 , total_bytes=18611 , proto=UDP , src=199.193.251.108 , dst=192.168.1.50 , dport=1194 , time=139
6 , total_bytes=14372 , proto=UDP , src=10.200.1.10 , dst=10.200.1.1 , dport=1514 , time=137
7 , total_bytes=3456 , proto=ICMP , src=192.168.1.50 , dst=8.8.8.8 , dport= , time=139
8 , total_bytes=3296 , proto=TCP , src=11.111.11.111 , dst=192.168.1.50 , dport=22 , time=5
9 , total_bytes=1476 , proto=UDP , src=192.168.1.50 , dst=64.13.172.36 , dport=50231 , time=130
10 , total_bytes=1105 , proto=UDP , src=10.200.1.18 , dst=10.200.1.1 , dport=1514 , time=21
11 , total_bytes=694 , proto=UDP , src=10.200.1.14 , dst=10.200.1.1 , dport=1514 , time=1
12 , total_bytes=576 , proto=TCP , src=10.200.1.1 , dst=10.200.1.18 , dport=46323 , time=140
13 , total_bytes=509 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=51390 , time=0
14 , total_bytes=509 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=52233 , time=0
15 , total_bytes=509 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=43625 , time=0
16 , total_bytes=509 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=40731 , time=0
17 , total_bytes=453 , proto=UDP , src=192.168.1.50 , dst=192.168.1.1 , dport=53 , time=1
18 , total_bytes=446 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=53 , time=0
19 , total_bytes=318 , proto=UDP , src=69.251.184.163 , dst=192.168.1.50 , dport=1194 , time=136
20 , total_bytes=185 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=59605 , time=0
21 , total_bytes=181 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=35843 , time=0
22 , total_bytes=128 , proto=ICMP , src=192.168.1.50 , dst=4.2.2.2 , dport= , time=1
23 , total_bytes=123 , proto=UDP , src=127.0.0.1 , dst=127.0.0.1 , dport=57377 , time=0
24 , total_bytes=74 , proto=TCP , src=192.168.1.50 , dst=67.218.118.62 , dport=6667 , time=1
25 , total_bytes=48 , proto=ICMP , src=192.168.1.50 , dst=221.1.118.174 , dport= , time=0
26 , total_bytes=0 , proto=TCP , src=220.202.0.188 , dst=192.168.56.100 , dport=22 , time=1
27 , total_bytes=0 , proto=TCP , src=221.1.118.174 , dst=192.168.56.100 , dport=1433 , time=1

root@serv:~/admin/git/ttt# perl ttt.pl --in dump.txt --summary=0
1363810443.557503 IP 127.0.0.1.53  > 127.0.0.1.59605  UDP length 185
1363810447.819104 IP 10.200.1.18.46324  > 10.200.1.1.22  TCP length 52553
1363810447.865764 IP 10.200.1.18.46324  > 10.200.1.1.22  TCP length 0
1363810362.037205 IP 11.111.11.111.49712  > 192.168.1.50.22  TCP length 3296
1363810366.772445 IP 11.111.11.111.49712  > 192.168.1.50.22  TCP length 0
1363810340.994391 IP 192.168.1.50.1194  > 64.13.172.36.50231  UDP length 1476
1363810470.079920 IP 192.168.1.50.1194  > 64.13.172.36.50231  UDP length 0
1363810467.702769 IP 127.0.0.1.53  > 127.0.0.1.51390  UDP length 509
1363810435.853889 IP 192.168.1.50.57996  > 67.218.118.62.6667  TCP length 74
1363810435.941372 IP 192.168.1.50.57996  > 67.218.118.62.6667  TCP length 0
1363810332.676740 IP 192.168.1.50.1194  > 11.111.11.111.56741  UDP length 89674
1363810472.126060 IP 192.168.1.50.1194  > 11.111.11.111.56741  UDP length 0
1363810365.895103 IP 192.168.1.50 > 4.2.2.2 ICMP length 128
1363810365.923202 IP 192.168.1.50 > 4.2.2.2 ICMP length 0
1363810341.110245 IP 192.168.1.50 > 221.1.118.174 ICMP length 48
1363810333.920681 IP 192.168.1.50 > 8.8.8.8 ICMP length 3456
1363810472.066943 IP 192.168.1.50 > 8.8.8.8 ICMP length 0
1363810437.519300 IP 10.200.1.18.57167  > 10.200.1.1.1514  UDP length 1105
1363810457.540908 IP 10.200.1.18.57167  > 10.200.1.1.1514  UDP length 0
1363810467.538161 IP 127.0.0.1.53  > 127.0.0.1.57377  UDP length 123
1363810443.526282 IP 192.168.1.50.28708  > 192.168.1.1.53  UDP length 453
1363810443.557309 IP 192.168.1.50.28708  > 192.168.1.1.53  UDP length 0
1363810467.813716 IP 127.0.0.1.53  > 127.0.0.1.52233  UDP length 509
1363810440.012027 IP 10.200.1.14.36853  > 10.200.1.1.1514  UDP length 694
1363810440.014265 IP 10.200.1.14.36853  > 10.200.1.1.1514  UDP length 0
1363810353.356361 IP 220.202.0.188.53701  > 192.168.56.100.22  TCP length 0
1363810353.366751 IP 220.202.0.188.53701  > 192.168.56.100.22  TCP length 0
1363810332.676696 IP 10.200.1.1.22  > 10.200.1.18.46323  TCP length 576
1363810472.126148 IP 10.200.1.1.22  > 10.200.1.18.46323  TCP length 0
1363810469.817967 IP 127.0.0.1.53  > 127.0.0.1.43625  UDP length 509
1363810443.371101 IP 127.0.0.1.53  > 127.0.0.1.35843  UDP length 181
1363810334.640338 IP 69.251.184.163.45563  > 192.168.1.50.1194  UDP length 318
1363810470.210685 IP 69.251.184.163.45563  > 192.168.1.50.1194  UDP length 0
1363810347.845906 IP 11.111.11.111.50192  > 192.168.1.50.65505  TCP length 936638
1363810469.193625 IP 11.111.11.111.50192  > 192.168.1.50.65505  TCP length 0
1363810333.960101 IP 199.193.251.108.60434  > 192.168.1.50.1194  UDP length 18611
1363810472.038427 IP 199.193.251.108.60434  > 192.168.1.50.1194  UDP length 0
1363810468.817272 IP 127.0.0.1.53  > 127.0.0.1.40731  UDP length 509
1363810333.960200 IP 10.200.1.10.48833  > 10.200.1.1.1514  UDP length 14372
1363810470.140520 IP 10.200.1.10.48833  > 10.200.1.1.1514  UDP length 0
1363810443.557618 IP 192.168.1.50.53608  > 199.193.251.107.80  TCP length 43839
1363810454.749904 IP 192.168.1.50.53608  > 199.193.251.107.80  TCP length 0
1363810341.100285 IP 221.1.118.174.6000  > 192.168.56.100.1433  TCP length 0
1363810341.110205 IP 221.1.118.174.6000  > 192.168.56.100.1433  TCP length 0
1363810467.813567 IP 127.0.0.1.52233  > 127.0.0.1.53  UDP length 446
		
root@serv:~/admin/git/ttt# perl ttt.pl --help
[+] Help:
				--in			:	tcpdump log file: tcpdump -tt -nn -q -i derp0 ...
				--out			:	Output file, stdout by default
				--condense		:	Condense traffic table
				--iponly		:	Maximum condensed data, only keep track of src/dst ip pairs
				--summary		:	Print (or not) out a summary of the flows / top talkers
				--columns		:	Print (or not) output in columns format
				--fortigate		:	Process the input log as a fortigate diag sniffer packet log
				--debug			:	Print out debugging information	
				--help			:	This menu
		
root@serv:~/admin/git/ttt# 

:wq
